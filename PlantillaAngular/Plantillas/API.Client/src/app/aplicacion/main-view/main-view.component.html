<ion-header>
  <ion-toolbar class="dashboard-header">
    <div class="header-content">
      <div class="brand">
        <span class="brand-icon">üöÄ</span>
        <div class="brand-text">
          <h1>Panel de Portfolio</h1>
          <p>Aplicaci√≥n Full-Stack ‚Ä¢ Clean Architecture ‚Ä¢ GraphQL</p>
        </div>
      </div>

      <div class="header-stats" *ngIf="!isLoading() && projects().length > 0">
        <div class="stat-item">
          <span class="stat-value">{{ projects().length }}</span>
          <span class="stat-label">Proyectos</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ getTotalTasks() }}</span>
          <span class="stat-label">Total Tareas</span>
        </div>
        <div class="stat-item completed">
          <span class="stat-value">{{ getCompletedTasks() }}</span>
          <span class="stat-label">Completadas</span>
        </div>
        <div class="stat-item in-progress">
          <span class="stat-value">{{ getInProgressTasks() }}</span>
          <span class="stat-label">En Progreso</span>
        </div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Notifications positioned inside ion-content so body won't scroll -->
  <div class="notifications">
    <div *ngIf="successMessage()" class="notification success">
      <span>‚úì</span> {{ successMessage() }}
    </div>
    <div *ngIf="errorMessage()" class="notification error">
      <span>‚ö†Ô∏è</span> {{ errorMessage() }}
      <ion-button fill="clear" size="small" class="close-btn" (click)="errorMessage.set(null)" aria-label="Cerrar error">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </div>
    <div *ngIf="isUpdating()" class="notification updating">
      <span class="spinner"></span> Actualizando...
    </div>
  </div>

  <ng-container *ngIf="isLoading()">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Cargando tu portfolio...</p>
    </div>
  </ng-container>

  <ion-grid *ngIf="!isLoading()" class="dashboard-grid">
    <ion-row>
      <ion-col size="12" size-md="4">
        <aside class="projects-sidebar">
          <div class="sidebar-header">
            <h2>üìÅ Proyectos</h2>
            <div class="sidebar-actions">
              <ion-button fill="solid" class="add-btn chocolate-btn" (click)="openCreateProjectDialog()" aria-label="Nuevo proyecto">
                <ion-icon slot="start" name="add-outline"></ion-icon>
                <span class="btn-label">Nuevo</span>
              </ion-button>
              <ion-button fill="clear" class="refresh-btn" (click)="loadProjects()" aria-label="Actualizar">
                <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
              </ion-button>
            </div>
          </div>

          <div class="projects-list">
            <app-project-card 
              *ngFor="let project of projects()"
              [project]="project"
              [selected]="selectedProject()?.projectId === project.projectId"
              (selectProject)="selectProject($event)"
              (editProject)="openEditProjectDialog($event)"
              (deleteProject)="confirmDeleteProject($event)">
            </app-project-card>

            <div *ngIf="projects().length === 0" class="empty-projects">
              <span class="empty-icon">üì≠</span>
              <p>No se encontraron proyectos</p>
              <small>Haz clic en ‚ûï para crear uno nuevo</small>
              <ion-button class="create-first-btn" fill="solid" color="primary" (click)="openCreateProjectDialog()">
                <ion-icon slot="start" name="add-outline"></ion-icon>
                Crear primer proyecto
              </ion-button>
            </div>
          </div>
        </aside>
      </ion-col>

      <ion-col size="12" size-md="8">
        <section class="kanban-section">
          <div *ngIf="selectedProject()" class="project-header">
            <div class="project-info">
              <h2>{{ selectedProject()?.name }}</h2>
              <p>{{ selectedProject()?.description }}</p>
            </div>
            <div class="project-actions">
              <ion-button fill="solid" class="chocolate-btn" (click)="openCreateTaskDialog(selectedProject()!)">
                <ion-icon slot="start" name="add-outline"></ion-icon>
                Nueva Tarea
              </ion-button>
            </div>
          </div>

          <app-kanban-board 
            *ngIf="selectedProject()"
            [tasks]="selectedProject()?.tasks || []"
            (taskStatusChanged)="onTaskStatusChanged($event)"
            (editTask)="openEditTaskDialog($event)"
            (deleteTask)="confirmDeleteTask($event)">
          </app-kanban-board>

          <div *ngIf="!selectedProject() && projects().length > 0" class="select-project">
            <span class="select-icon">üëà</span>
            <p>Selecciona un proyecto para ver las tareas</p>
          </div>
        </section>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Modal para crear proyecto (se mantiene simple) -->
  <div class="modal-overlay" *ngIf="showCreateModal()" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚ûï Nuevo Proyecto</h2>
        <ion-button fill="clear" class="modal-close" (click)="closeCreateModal()" aria-label="Cerrar modal">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="projectName">Nombre del proyecto *</label>
          <input 
            type="text" 
            id="projectName" 
            [(ngModel)]="newProjectName"
            placeholder="Ej: Mi aplicaci√≥n web"
            maxlength="200"
            [disabled]="isCreating()">
        </div>
        
        <div class="form-group">
          <label for="projectDescription">Descripci√≥n (opcional)</label>
          <textarea 
            id="projectDescription" 
            [(ngModel)]="newProjectDescription"
            placeholder="Describe brevemente el proyecto..."
            rows="3"
            maxlength="1000"
            [disabled]="isCreating()">
          </textarea>
        </div>
      </div>
      
      <div class="modal-footer">
        <ion-button fill="clear" class="btn-cancel" (click)="closeCreateModal()" [disabled]="isCreating()">
          Cancelar
        </ion-button>
        <ion-button fill="solid" class="btn-create" (click)="createProject()" [disabled]="isCreating() || !newProjectName.trim()">
          <span *ngIf="isCreating()" class="spinner-small"></span>
          {{ isCreating() ? 'Creando...' : 'Crear Proyecto' }}
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>

<!-- Modal para crear proyecto -->
<div class="modal-overlay" *ngIf="showCreateModal()" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ûï Nuevo Proyecto</h2>
      <ion-button fill="clear" class="modal-close" (click)="closeCreateModal()" aria-label="Cerrar modal">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="projectName">Nombre del proyecto *</label>
        <input 
          type="text" 
          id="projectName" 
          [(ngModel)]="newProjectName"
          placeholder="Ej: Mi aplicaci√≥n web"
          maxlength="200"
          [disabled]="isCreating()">
      </div>
      
      <div class="form-group">
        <label for="projectDescription">Descripci√≥n (opcional)</label>
        <textarea 
          id="projectDescription" 
          [(ngModel)]="newProjectDescription"
          placeholder="Describe brevemente el proyecto..."
          rows="3"
          maxlength="1000"
          [disabled]="isCreating()">
        </textarea>
      </div>
    </div>
    
    <div class="modal-footer">
      <ion-button fill="clear" class="btn-cancel" (click)="closeCreateModal()" [disabled]="isCreating()">
        Cancelar
      </ion-button>
      <ion-button fill="solid" class="btn-create" (click)="createProject()" [disabled]="isCreating() || !newProjectName.trim()">
        <span *ngIf="isCreating()" class="spinner-small"></span>
        {{ isCreating() ? 'Creando...' : 'Crear Proyecto' }}
      </ion-button>
    </div>
  </div>
</div>
